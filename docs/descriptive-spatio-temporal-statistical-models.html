<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Descriptive Spatio-Temporal Statistical Models | Spatio Temporal Statistics</title>
  <meta name="description" content="This is a gitbook for spatio temporal analysis." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Descriptive Spatio-Temporal Statistical Models | Spatio Temporal Statistics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a gitbook for spatio temporal analysis." />
  <meta name="github-repo" content="bohyunshin/spatio-temporal" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Descriptive Spatio-Temporal Statistical Models | Spatio Temporal Statistics" />
  
  <meta name="twitter:description" content="This is a gitbook for spatio temporal analysis." />
  

<meta name="author" content="BoHyun Shin" />


<meta name="date" content="2020-07-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatio-temporal-statistical-models.html"/>
<link rel="next" href="dynamic-spatio-temporal-models.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio Temporal Gitbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Being Familiar with STD</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Exploring Spatio Temporal Data</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#representation-of-spatio-temporal-data-in-r"><i class="fa fa-check"></i><b>1.1</b> Representation of Spatio Temporal Data in R</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#visualization-of-std"><i class="fa fa-check"></i><b>1.2</b> Visualization of STD</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#exploratory-analysis-of-std"><i class="fa fa-check"></i><b>1.3</b> Exploratory Analysis of STD</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#empirical-spatial-means-and-covariances"><i class="fa fa-check"></i><b>1.3.1</b> Empirical Spatial Means and Covariances</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#elements-of-point-referenced-modeling"><i class="fa fa-check"></i><b>1.3.2</b> Elements of point-referenced modeling</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#empirical-orthogonal-functions-eofs"><i class="fa fa-check"></i><b>1.3.3</b> Empirical Orthogonal Functions (EOFs)</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#wrap-up"><i class="fa fa-check"></i><b>1.4</b> Wrap up</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="mapping-spatio-temporal-data.html"><a href="mapping-spatio-temporal-data.html"><i class="fa fa-check"></i><b>2</b> Mapping Spatio Temporal Data</a><ul>
<li class="chapter" data-level="2.1" data-path="mapping-spatio-temporal-data.html"><a href="mapping-spatio-temporal-data.html#some-basic-class-regarding-spatio-temporal-data-in-r"><i class="fa fa-check"></i><b>2.1</b> Some basic class regarding spatio-temporal data in R</a></li>
<li class="chapter" data-level="2.2" data-path="mapping-spatio-temporal-data.html"><a href="mapping-spatio-temporal-data.html#package"><i class="fa fa-check"></i><b>2.2</b> Package</a></li>
</ul></li>
<li class="part"><span><b>II Modeling Spatio-Temporal Data</b></span></li>
<li class="chapter" data-level="3" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html"><i class="fa fa-check"></i><b>3</b> Spatio-Temporal Statistical Models</a><ul>
<li class="chapter" data-level="3.1" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html#spatio-temporal-prediction"><i class="fa fa-check"></i><b>3.1</b> Spatio-Temporal Prediction</a><ul>
<li class="chapter" data-level="3.1.1" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html#deterministic-prediction"><i class="fa fa-check"></i><b>3.1.1</b> Deterministic Prediction</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html#regression-estimation"><i class="fa fa-check"></i><b>3.2</b> Regression Estimation</a></li>
<li class="chapter" data-level="3.3" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html#gaussian-or-non-gaussian-errors"><i class="fa fa-check"></i><b>3.3</b> Gaussian or Non Gaussian Errors</a></li>
<li class="chapter" data-level="3.4" data-path="spatio-temporal-statistical-models.html"><a href="spatio-temporal-statistical-models.html#hierarchical-spatio-temporal-statistical-models"><i class="fa fa-check"></i><b>3.4</b> Hierarchical Spatio-Temporal Statistical Models</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html"><i class="fa fa-check"></i><b>4</b> Descriptive Spatio-Temporal Statistical Models</a><ul>
<li class="chapter" data-level="4.1" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#additive-measurement-error-and-process-models"><i class="fa fa-check"></i><b>4.1</b> Additive Measurement Error and Process models</a></li>
<li class="chapter" data-level="4.2" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#prediction-for-gaussian-data-and-processes."><i class="fa fa-check"></i><b>4.2</b> prediction for Gaussian Data and Processes.</a><ul>
<li class="chapter" data-level="4.2.1" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#spatio-temporal-covariance-functions"><i class="fa fa-check"></i><b>4.2.1</b> Spatio-Temporal Covariance Functions</a></li>
<li class="chapter" data-level="4.2.2" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#spatio-temporal-semivariograms"><i class="fa fa-check"></i><b>4.2.2</b> Spatio-Temporal Semivariograms</a></li>
<li class="chapter" data-level="4.2.3" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#gaussian-spatio-temporal-model-estimation"><i class="fa fa-check"></i><b>4.2.3</b> Gaussian Spatio-Temporal Model Estimation</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#random-effects-parameterizations"><i class="fa fa-check"></i><b>4.3</b> Random-Effects Parameterizations</a></li>
<li class="chapter" data-level="4.4" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#basis-function-representations"><i class="fa fa-check"></i><b>4.4</b> Basis-Function Representations</a><ul>
<li class="chapter" data-level="4.4.1" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#random-effects-with-spatio-temporal-basis-functionss"><i class="fa fa-check"></i><b>4.4.1</b> Random Effects with Spatio-Temporal Basis Functionss</a></li>
<li class="chapter" data-level="4.4.2" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#random-effects-with-spatial-basis-functions."><i class="fa fa-check"></i><b>4.4.2</b> Random Effects with Spatial Basis Functions.</a></li>
<li class="chapter" data-level="4.4.3" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#random-effects-with-temporal-basis-functions"><i class="fa fa-check"></i><b>4.4.3</b> Random Effects with Temporal Basis Functions</a></li>
<li class="chapter" data-level="4.4.4" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#confounding-of-fixed-effects-and-random-effects"><i class="fa fa-check"></i><b>4.4.4</b> Confounding of Fixed Effects and Random Effects</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#lab-package-frk"><i class="fa fa-check"></i><b>4.5</b> Lab: Package FRK</a></li>
<li class="chapter" data-level="4.6" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#lab-non-gaussian-spatio-temporal-gams-with-mgvv"><i class="fa fa-check"></i><b>4.6</b> Lab: Non-Gaussian Spatio-Temporal GAMs with mgvv</a></li>
<li class="chapter" data-level="4.7" data-path="descriptive-spatio-temporal-statistical-models.html"><a href="descriptive-spatio-temporal-statistical-models.html#non-gaussian-spatio-temporal-models-with-inla"><i class="fa fa-check"></i><b>4.7</b> Non-Gaussian Spatio-Temporal Models with INLA</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html"><i class="fa fa-check"></i><b>5</b> Dynamic Spatio-Temporal Models</a><ul>
<li class="chapter" data-level="5.1" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#general-dynamic-spatio-temporal-models"><i class="fa fa-check"></i><b>5.1</b> General Dynamic Spatio-Temporal Models</a><ul>
<li class="chapter" data-level="5.1.1" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#process-model"><i class="fa fa-check"></i><b>5.1.1</b> Process Model</a></li>
<li class="chapter" data-level="5.1.2" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#parameters"><i class="fa fa-check"></i><b>5.1.2</b> Parameters</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#latent-linear-gaussian-dstms"><i class="fa fa-check"></i><b>5.2</b> Latent Linear Gaussian DSTMs</a><ul>
<li class="chapter" data-level="5.2.1" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#linear-data-model-with-additive-gaussian-error"><i class="fa fa-check"></i><b>5.2.1</b> Linear Data Model with Additive Gaussian Error</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="dynamic-spatio-temporal-models.html"><a href="dynamic-spatio-temporal-models.html#process-and-parameter-dimension-reduction"><i class="fa fa-check"></i><b>5.3</b> Process and Parameter Dimension Reduction</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio Temporal Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="descriptive-spatio-temporal-statistical-models" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Descriptive Spatio-Temporal Statistical Models</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-1"></a><span class="kw">library</span>(<span class="st">&quot;sp&quot;</span>)</span>
<span id="cb1-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-2"></a><span class="kw">library</span>(<span class="st">&quot;spacetime&quot;</span>)</span>
<span id="cb1-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-3"></a><span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb1-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-4"></a><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb1-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-5"></a><span class="kw">library</span>(<span class="st">&quot;gstat&quot;</span>)</span>
<span id="cb1-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-6"></a><span class="kw">library</span>(<span class="st">&quot;RColorBrewer&quot;</span>)</span>
<span id="cb1-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-7"></a><span class="kw">library</span>(<span class="st">&quot;STRbook&quot;</span>)</span>
<span id="cb1-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-8"></a><span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)</span>
<span id="cb1-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-9"></a><span class="kw">library</span>(<span class="st">&quot;grid&quot;</span>)</span>
<span id="cb1-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb1-10"></a><span class="kw">library</span>(<span class="st">&quot;gridExtra&quot;</span>)</span></code></pre></div>
<p>We saw that there are two approaches for spatio-temporal statistics, which is <em>two D’s</em>. One is descriptive approach which will be covered in this chapter. The other is dynamic approach which will be introduced in the next chapter. Our main goals are 1) to predict unknown value at some location and time point, 2) to estimate spatio-temporal covariates. For both goals, we assume the our observations can be decomposed as</p>
<p><em>observations = true process + observation error</em><br />
<em>true process = regression component + dependent random process </em><br />
</p>
<p>For descriptive approach, our main concern is to specify the dependence structure in the (dependent) random process whereas dynamic approach is mainly interested in the evolution of the dependent random process through time.</p>
<div id="additive-measurement-error-and-process-models" class="section level2">
<h2><span class="header-section-number">4.1</span> Additive Measurement Error and Process models</h2>
<p>In this section, we consider two stage model, which consists of data (observation) model and a process model that is again consists of fixed effect and random effect. This general decomposition is the basis for the models that we present in this and next chapter.<br />
Recall that for eath time point <span class="math inline">\(t \in \{t_1, \cdots, t_T \}\)</span>, we assume <span class="math inline">\(m_{t_j}\)</span> observations. That is, our observation is</p>
<p><span class="math display">\[\begin{equation}
  \mathbb{Z} = Z(s_{11}; t_1), Z(s_{21}; t_1), \cdots Z(s_{m_1 1}; t_1), \cdots, Z(s_{1T}; t_T), \cdots, Z(s_{m_t T}; t_T)
\end{equation}\]</span></p>
<p>In the situation where we want to predict values at spatio-temporal location <span class="math inline">\((s_0; t_0)\)</span>, if <span class="math inline">\(t_0 &gt; t_T\)</span>, we are in a forecasting situation and if <span class="math inline">\(t_0 &lt; t_T\)</span>, we have all data avilable to us, so we are in a smoothing situation. We assume that there is an underlying latent random spatio-temporal process which is denoted by <span class="math inline">\(Y(s;t): s\in D_s, t\in D_t\)</span>. However, what we see from the data is the noisy version of this latent random process, which is denoted by</p>
<p><span class="math display">\[\begin{equation}
  Z(s_{ij}; t_j) = Y(s_{ij}; t_j) + \epsilon(s_{ij}; t_j) \tag{1}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\epsilon(s_{ij}; t_j)\)</span> represent iid mean-zero measurement error that is independent of <span class="math inline">\(Y\)</span> and has variance <span class="math inline">\(\sigma^2_\epsilon\)</span>. Now we assume that the latent process model follows another model as</p>
<p><span class="math display">\[\begin{equation}
  Y(s;t) = \mu(s;t) + \eta(s;t) \tag{2}
\end{equation}\]</span></p>
<p>In (2), <span class="math inline">\(\mu(s;t)\)</span> represents the process mean which is not random and <span class="math inline">\(\eta(s;t)\)</span> represents a mean-zero random process with spatial and temporal statistical dependence. Depending on the problem, we may choose <span class="math inline">\(\mu(s;t)\)</span> as 1) known, 2) constant but unknown, 3) modeled in terms of <span class="math inline">\(p\)</span> covariates, i.e., <span class="math inline">\(\mu(s;t) = x(s;t)&#39;\beta\)</span>, which is called respectively as 1) simple, 2) ordinary, 3) universal kriging.</p>
</div>
<div id="prediction-for-gaussian-data-and-processes." class="section level2">
<h2><span class="header-section-number">4.2</span> prediction for Gaussian Data and Processes.</h2>
<p>In chapter 2, recall that we consider some deterministic weight, which is IDW, that smoothes surrounding data points. In making the IDW, no statistical optimal methods are used, but cross validation for determining <span class="math inline">\(\alpha\)</span> is used. Now, we consider a optimization criterion, which is <span class="math inline">\(E(Y(s_0; t_0) - \hat{Y}(s_0; t_0))^2\)</span>, the mean square prediction error (MPSE). The best linear unbiased predictor that minimizes the MSPE is referred as the <strong>kriging predictor</strong>. To determine optimal linear predictor, which we henceforth call <em>S-T kriging</em>, it is convenient to assume that the underlying latent process is a Gaussian process and the measurement error has a Gaussian distribution. In vector representation,</p>
<p><span class="math display">\[\begin{equation}
  \mathbf{Z} = \mathbf{Y} + \epsilon \\
  \mathbf{Y} = \mathbb{\mu} + \mathbb{\eta} \tag{3}
\end{equation}\]</span></p>
<p>where we assume universal kriging, i.e., <span class="math inline">\(\mathbb{\mu} = \mathbf{X} \mathbb{\beta}\)</span>. Also, <span class="math inline">\(Cov(\mathbf{Y}) \equiv \mathbf{C}_y = \mathbf{C}_\eta\)</span>, <span class="math inline">\(Cov(\epsilon) \equiv \mathbf{C}_\epsilon\)</span>, <span class="math inline">\(Cov(\mathbf{Z}) \equiv \mathbf{C}_z = \mathbf{C}_y + \mathbf{C}_\epsilon\)</span>. For <span class="math inline">\((s_0, t_0)\)</span>, consider the joint Gaussian distribution,</p>
<p><span class="math display">\[\begin{equation}
  
  \left[ {\begin{array}{cc}
   Y(s_0; t_0) \\
   \mathbf{Z} \\
  \end{array} } \right]
  
  \sim
  
  Gau \left( 
  
  \left[ {\begin{array}{cc}
   Y(s_0; t_0) \\
   \mathbf{Z} \\
  \end{array} } \right] \mathbf{\beta},
  
  \left[ {\begin{array}{cc}
   c_{0,0} &amp; \mathbf{c}^{&#39;}_0 \\
   \mathbf{c}_0 &amp; \mathbf{C}_z \\
  \end{array} } \right]
  
  \right) \tag{4}

\end{equation}\]</span></p>
<p>By the property of Gaussian distribution, the conditional distribution can be derived easily,</p>
<p><span class="math display">\[\begin{equation}
  Y(s_0; t_0) \mid \mathbf{Z} \sim Gau( mean, var) \tag{5}
\end{equation}\]</span></p>
<p>where the conditional mean in (5) is S-T simple kriging predictor,</p>
<p><span class="math display">\[\begin{equation}
  \hat{Y}(s_0; t_0) = \mathbf{x}(s_0; t_0)&#39; \beta + \mathbf{c}&#39;_0 \mathbf{C}^{-1}_z (\mathbf{Z} - \mathbf{X\beta}) \tag{6}
\end{equation}\]</span></p>
<p>and the variance is the conditional variance in (5)</p>
<p><span class="math display">\[\begin{equation}
  \sigma^2_{Y, sk}(s_0; t_0) = c_{0,0} - \mathbf{c}&#39;_0 \mathbf{C}^{-1}_z \mathbf{c}_0 \tag{7}
\end{equation}\]</span></p>
<p>Note that for any location, we can get S-T simple kriging predictor. This means that we assume that the process is defined for an uncountable set of locations and the data correspond to a partial realization of this process. This is also a property of Gaussian process.<br />
Another note is that from (6), the S-T simple kriging predictor is the combiation of original mean and the residual, where the weight is <span class="math inline">\(\mathbf{w} \equiv \mathbf{c}&#39;_0 \mathbf{C}^{-1}_z\)</span>. This can be views as the trend term <span class="math inline">\(\mathbf{x}(s_0; t_0)&#39;\beta\)</span> is the mean of <span class="math inline">\(Y(s_0; t_0)\)</span> prior to considering the observations.<br />
</p>
<p>Note that <span class="math inline">\(\beta\)</span> is unknown parameter, which is to be estimated. Replacing it with the gls estimator, we get the optimal linear unbiased predictor, or S-T universal kriging predictor of <span class="math inline">\(Y(s_0; t_0)\)</span> as</p>
<p><span class="math display">\[\begin{equation}
  \hat{Y}(s_0; t_0) = \mathbf{x}(s_0; t_0)&#39; \hat{\beta}_{gls} + \mathbf{c}&#39;_0 \mathbf{C}^{-1}_z (\mathbf{Z} - \mathbf{X\hat{\beta}_{gls}}) \tag{8}
\end{equation}\]</span></p>
<p>where</p>
<p><span class="math display">\[\begin{equation}
  \hat{\beta}_{gls} \equiv (\mathbf{X}&#39; \mathbf{C}^{-1}_z \mathbf{X})^{-1} \mathbf{X}&#39; \mathbf{C}^{-1}_z \mathbf{Z} \tag{9}
\end{equation}\]</span></p>
<p>with</p>
<p><span class="math display">\[\begin{equation}
  \sigma^2_{Y, sk}(s_0; t_0) = c_{0,0} - \mathbf{c}&#39;_0 \mathbf{C}^{-1}_z \mathbf{c}_0 + \kappa \tag{10}
\end{equation}\]</span></p>
<p>which is prediction standard error. For those of you who learn the spatial statistics before, the form of kriging estimator and variance is vary similar of that of spatio-temporal estimator.<br />
In practice, we also do not know the covariance function, <span class="math inline">\(\mathbf{C}_z, \mathbf{c}_0\)</span>, so we need to assume the structure of covariance function or parameterize to estimate them. Similar with spatial statistics, the parameterization of these covariance function is one of the most difficult challenges in spatio-temporal statistics.</p>
<div id="spatio-temporal-covariance-functions" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Spatio-Temporal Covariance Functions</h3>
<p>As mentioned above, we need to know covariance function, i.e., <span class="math inline">\(\mathbf{C}_z, \mathbf{c}_0\)</span>, to get the S-T kriging predictors. However, not any matrix can be covariance function, which requires some conditions, i.e., non-negative-definite. The general spatio-temporal covariance function would be</p>
<p><span class="math display">\[\begin{equation}
  c_*(s,s&#39; ; t,t&#39;) \equiv Cov(Y(s;t), Y(s&#39;;t&#39;)) \tag{11}
\end{equation}\]</span></p>
<p>In practice, we commonly assume second-order stationary; the random process is said to be second-order (or weakly) stationary if it has a constant expection and the covariance function would be expressed in terms of only spatioal and temporal lags not others. That is,</p>
<p><span class="math display">\[\begin{equation}
  c_*(s,s&#39; ; t,t&#39;) = c(s&#39;-s; t&#39;-t) = c(h; \tau) \tag{12}
\end{equation}\]</span></p>
<p>The second-order stationary assumption gives us many advantages, which allows some easy expression of covariance function, thus easy interpretation. Then, how do we obtain valid stationary spatio-temporal covariance functions? Depending on the way we define spatio-temporal covariance, the resulting sample variogram will be different. So, it is important step before modeling spatio-temporal data. Previously, we plot the spatio-temporal sample semivariogram as below.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-1"></a><span class="kw">data</span>(<span class="st">&quot;STObj3&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</span>
<span id="cb2-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-2"></a>STObj4 &lt;-<span class="st"> </span>STObj3[, <span class="st">&quot;1993-07-01::1993-07-31&quot;</span>]</span>
<span id="cb2-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-3"></a>vv &lt;-<span class="st"> </span><span class="kw">variogram</span>(<span class="dt">object =</span> z <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>lat, <span class="co"># fixed effect component</span></span>
<span id="cb2-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-4"></a>                <span class="dt">data =</span> STObj4,      <span class="co"># July data</span></span>
<span id="cb2-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-5"></a>                <span class="dt">width =</span> <span class="dv">80</span>,         <span class="co"># spatial bin (80 km)</span></span>
<span id="cb2-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-6"></a>                <span class="dt">cutoff =</span> <span class="dv">1000</span>,      <span class="co"># consider pts &lt; 1000 km apart</span></span>
<span id="cb2-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-7"></a>                <span class="dt">tlags =</span> <span class="fl">0.01</span><span class="op">:</span><span class="fl">6.01</span>)  <span class="co"># 0 days to 6 days</span></span>
<span id="cb2-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb2-8"></a><span class="kw">plot</span>(vv)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Note some clear patterns in the plot, which is a good evidence for spatio-temporal modeling. In this section, we assume spatio-temporal covariance and calculate corresponding empirical variograms.</p>
<p><strong>Separable (in Space and Time) Covariance Functions</strong><br />
Separable covariance function have often been used because it is simple, easy to interpret but guarantee validity. It is given by the identity</p>
<p><span class="math display">\[\begin{equation}
  c(h; \tau) \equiv c^{(s)}(h) \cdot c^{(t)}(\tau)
\end{equation}\]</span></p>
<p>There are lots of valid spatial covariance function and valid temporal covariance function. For example, the most widely used one is Matern covariance function, which is</p>
<p><span class="math display">\[\begin{equation}
  c^{(s)}(h) = \sigma^2_s exp \{ - \dfrac{||h||}{a_s} \}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\sigma^2_s\)</span> is the variance parameter and <span class="math inline">\(a_s\)</span> is the spatial dependence parameter. More <span class="math inline">\(a_s\)</span> results in smaller value in exponential, meaning large value of <span class="math inline">\(\mathbf{c}(h)\)</span>. Moreover, separable covariance function reduce computation time, becuase the spatio-temporal covariance function can be decomposed into kronecker product. Because we have to compute inverse matrix of spatio-temporal covariance function, the computation could be enormously. However, by using the property of kronecker, we could reduce lots of computation.<br />
However, separable covariance function assumes that the temporal evolution of the process at a given spatial location does not depend directly on the process’ temporal evolution at other locations, which is very seldom for real-word. So we should consider other covariance functions, which will be discussed next.</p>
<p><strong>Sums-andProducts Formulation</strong><br />
Using the property that sums of non-negative-definite function is also non-negative-definite, we present another form of covariance function,</p>
<p><span class="math display">\[\begin{equation}
  c(h;\tau) \equiv p c^{(s)}_1 (h) \cdot c^{(t)}_1(\tau) + q c^{(s)}_2(h) + r c^{(t)}_2(\tau) \tag{13}
\end{equation}\]</span></p>
<p>Note that covariance function in (13) assumes fully symmetric spatio-temporal covariance function which is not realistic in real world.</p>
<p><strong>Construction via a Spectral Representation</strong><br />
Developed by Cressie and Huang, they express the covariance function as</p>
<p><span class="math display">\[\begin{equation}
  c(h;\tau) = \sigma^2 exp\{ -b^2 ||h||^2 / (a^2 \tau^2 + 1)  \} / (a^2 \tau^2 + 1)^{d/2} \tag{14}
\end{equation}\]</span></p>
<p><strong>Stochastic Partial Differential Equation (SPDE) Approach</strong><br />
Seldom, directly appropriate for physical processes but may still provide good fits to data.<br />
</p>
<p>For comparison, there are various spatio-temporal covariances in <span class="math inline">\(\texttt{gstat}\)</span> package. We will take a look at few of them now. First, we fit the sample spatio-temporal variogram using separable and metric spatio-temporal covariance function.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-1"></a>sepVgm &lt;-<span class="st"> </span><span class="kw">vgmST</span>(<span class="dt">stModel =</span> <span class="st">&quot;separable&quot;</span>,</span>
<span id="cb3-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-2"></a>                <span class="dt">space =</span> <span class="kw">vgm</span>(<span class="dv">10</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">400</span>, <span class="dt">nugget =</span> <span class="fl">0.1</span>),</span>
<span id="cb3-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-3"></a>                <span class="dt">time =</span> <span class="kw">vgm</span>(<span class="dv">10</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">1</span>, <span class="dt">nugget =</span> <span class="fl">0.1</span>),</span>
<span id="cb3-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-4"></a>                <span class="dt">sill =</span> <span class="dv">20</span>)</span>
<span id="cb3-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-5"></a>sepVgm &lt;-<span class="st"> </span><span class="kw">fit.StVariogram</span>(vv, sepVgm)</span>
<span id="cb3-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-6"></a></span>
<span id="cb3-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-7"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb3-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-8"></a>metricVgm &lt;-<span class="st"> </span><span class="kw">vgmST</span>(<span class="dt">stModel =</span> <span class="st">&quot;metric&quot;</span>,</span>
<span id="cb3-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-9"></a>                   <span class="dt">joint =</span> <span class="kw">vgm</span>(<span class="dv">100</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">400</span>, <span class="dt">nugget =</span> <span class="fl">0.1</span>),</span>
<span id="cb3-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-10"></a>                   <span class="dt">sill =</span> <span class="dv">10</span>,</span>
<span id="cb3-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-11"></a>                   <span class="dt">stAni =</span> <span class="dv">100</span>)</span>
<span id="cb3-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb3-12"></a>metricVgm &lt;-<span class="st"> </span><span class="kw">fit.StVariogram</span>(vv, metricVgm)</span></code></pre></div>
<p>Note that for <span class="math inline">\(\texttt{vgm, vgmST}\)</span>, it returns variograms for population version and <span class="math inline">\(\texttt{fit.stVariogram}\)</span> calculates sample variogram using them. We check which variogram fits better by comparing MSE.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb4-1"></a>metricMSE &lt;-<span class="st"> </span><span class="kw">attr</span>(metricVgm, <span class="st">&quot;optim&quot;</span>)<span class="op">$</span>value</span>
<span id="cb4-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb4-2"></a>sepMSE &lt;-<span class="st"> </span><span class="kw">attr</span>(sepVgm, <span class="st">&quot;optim&quot;</span>)<span class="op">$</span>value</span>
<span id="cb4-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb4-3"></a>metricMSE</span></code></pre></div>
<pre><code>## [1] 2.098101</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb6-1"></a>sepMSE</span></code></pre></div>
<pre><code>## [1] 1.419258</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb8-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb8-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb8-2"></a><span class="kw">plot</span>(vv, <span class="kw">list</span>(sepVgm, metricVgm), <span class="dt">main =</span> <span class="st">&quot;Semi-variance&quot;</span>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-4-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>Above plot is fitted semivariograms. After fitting semivariograms, we can get the stationary S-T covariance function by using.</p>
<p><span class="math display">\[\begin{equation}
  \gamma(h;\tau) = c(0;0) - c(h;\tau)
\end{equation}\]</span></p>
<p>Therefore, after estimating spatio-temporal covariance function, we can do universal S-T kriging. Recall that universal S-T kriging assumes the fixed effect in random process as a function of covariates, i.e., <span class="math inline">\(x\beta\)</span>. In this dataset, we found in chapter 2 that the latitude is an important covariate w.r.t response variable. For this reason, we include the latitude as a covariate and as a result of this, we do the universal S-T kriging. First of all, we need to create a space-time prediction grid. Note that any spatial grid is fine because of the infinite assumption of gaussian process. But we will consider some fixed areas and covert in toe the <span class="math inline">\(\texttt{SpatialPoints}\)</span> object. We ensure that the coordinate reference system of the prediction grid is the same as that of observations.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb9-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-2"></a>spat_pred_grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb9-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-3"></a>                      <span class="dt">lon =</span> <span class="kw">seq</span>(<span class="op">-</span><span class="dv">100</span>, <span class="dv">-80</span>, <span class="dt">length =</span> <span class="dv">20</span>),</span>
<span id="cb9-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-4"></a>                      <span class="dt">lat =</span> <span class="kw">seq</span>(<span class="dv">32</span>, <span class="dv">46</span>, <span class="dt">length =</span> <span class="dv">20</span>)) <span class="op">%&gt;%</span></span>
<span id="cb9-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-5"></a><span class="st">            </span><span class="kw">SpatialPoints</span>(<span class="dt">proj4string =</span> <span class="kw">CRS</span>(<span class="kw">proj4string</span>(STObj3)))</span>
<span id="cb9-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-6"></a><span class="kw">gridded</span>(spat_pred_grid) &lt;-<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb9-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-7"></a></span>
<span id="cb9-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-8"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb9-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-9"></a>temp_pred_grid &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;1993-07-01&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">3</span>, <span class="dv">28</span>, <span class="dt">length =</span> <span class="dv">6</span>)</span>
<span id="cb9-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-10"></a></span>
<span id="cb9-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-11"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb9-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-12"></a>DE_pred &lt;-<span class="st"> </span><span class="kw">STF</span>(<span class="dt">sp =</span> spat_pred_grid,    <span class="co"># spatial part</span></span>
<span id="cb9-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-13"></a>               <span class="dt">time =</span> temp_pred_grid)  <span class="co"># temporal part</span></span>
<span id="cb9-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-14"></a></span>
<span id="cb9-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-15"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb9-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-16"></a>STObj5 &lt;-<span class="st"> </span><span class="kw">as</span>(STObj4[, <span class="dv">-14</span>], <span class="st">&quot;STIDF&quot;</span>)         <span class="co"># convert to STIDF</span></span>
<span id="cb9-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-17"></a>STObj5 &lt;-<span class="st"> </span><span class="kw">subset</span>(STObj5, <span class="op">!</span><span class="kw">is.na</span>(STObj5<span class="op">$</span>z))   <span class="co"># remove missing data</span></span>
<span id="cb9-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-18"></a></span>
<span id="cb9-19"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-19"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb9-20"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-20"></a>pred_kriged &lt;-<span class="st"> </span><span class="kw">krigeST</span>(z <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>lat,         <span class="co"># latitude trend</span></span>
<span id="cb9-21"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-21"></a>                       <span class="dt">data =</span> STObj5,       <span class="co"># data set w/o 14 July</span></span>
<span id="cb9-22"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-22"></a>                       <span class="dt">newdata =</span> DE_pred,   <span class="co"># prediction grid</span></span>
<span id="cb9-23"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-23"></a>                       <span class="dt">modelList =</span> sepVgm,  <span class="co"># semivariogram</span></span>
<span id="cb9-24"><a href="descriptive-spatio-temporal-statistical-models.html#cb9-24"></a>                       <span class="dt">computeVar =</span> <span class="ot">TRUE</span>)   <span class="co"># compute variances</span></span></code></pre></div>
<p>We exclude the data on the day 14 for test data. In calculating kriging estimates, a little time is needed. But when the dataset becomes larger, we should consider other methods such as dimension reduction or basis functions.<br />
The estimates and prediction methods are as below.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-1"></a>color_pal &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">colorRampPalette</span>(<span class="kw">brewer.pal</span>(<span class="dv">11</span>, <span class="st">&quot;Spectral&quot;</span>))(<span class="dv">16</span>))</span>
<span id="cb10-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-2"></a></span>
<span id="cb10-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-3"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb10-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-4"></a><span class="kw">stplot</span>(pred_kriged,</span>
<span id="cb10-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-5"></a>      <span class="dt">main =</span> <span class="st">&quot;Predictions (degrees Fahrenheit)&quot;</span>,</span>
<span id="cb10-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-6"></a>      <span class="dt">layout =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>),</span>
<span id="cb10-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb10-7"></a>      <span class="dt">col.regions =</span> color_pal)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-6-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb11-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-2"></a>pred_kriged<span class="op">$</span>se &lt;-<span class="st"> </span><span class="kw">sqrt</span>(pred_kriged<span class="op">$</span>var1.var)</span>
<span id="cb11-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-3"></a><span class="kw">stplot</span>(pred_kriged[, , <span class="st">&quot;se&quot;</span>],</span>
<span id="cb11-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-4"></a>      <span class="dt">main =</span> <span class="st">&quot;Prediction std. errors (degrees Fahrenheit)&quot;</span>,</span>
<span id="cb11-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-5"></a>      <span class="dt">layout =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>),</span>
<span id="cb11-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb11-6"></a>      <span class="dt">col.regions =</span> color_pal)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-6-2.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="spatio-temporal-semivariograms" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Spatio-Temporal Semivariograms</h3>
<p>In spatial statistics, it is common to consider dependence through the spatial variogram. Likewise, we can consider spatio-temporal variogram as</p>
<p><span class="math display">\[\begin{equation}
  Var(Y(s;t) - Y(s&#39;;t&#39;)) \equiv 2 \gamma(s,s&#39;; t,t&#39;) \tag{15}
\end{equation}\]</span></p>
<p>Similar with the definition of stationary spatial process, the stationary version of spatio-temporal variogram is denoted by <span class="math inline">\(2\gamma(h;\tau)\)</span>. Although variogram is widely used as exploratory analysis to check spatial dependence, this is not the common case in spatio-temporal statistical modeling. The main reason for this is that most of the real-world processes are best described as <em>local</em> second-order stationarity. If only local staionarity is expected and modeled, the extra generality given by the variogram is not needed. If this extra generality is included in the model without caution, some undesirable situations may occurr, which results in un-optimal variogram-based kriging predictor. However, when using covariance-based kriging predictor, we do not have to worry about such things.</p>
</div>
<div id="gaussian-spatio-temporal-model-estimation" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Gaussian Spatio-Temporal Model Estimation</h3>
<p>In spatial statistics, it is common to fit covariance function (or semivariograms) directly to the empirical estimates, e.g., least squares or weighted least squares. However, in spatio-temporal statistics, we consider fully parameterized covariance structure and infer the parameters through likelikhood-based methods or bayesian methods.</p>
<p><strong>Likelihood Estimation</strong><br />
We consider following likelihood,</p>
<p><span class="math display">\[\begin{equation}
  L(\beta, \theta, Z) \propto |\mathbf{C}_z (\theta) |^{-1/2} exp \{ -\dfrac12(Z - X\beta)&#39; \mathbf{C}_z(\theta)^{-1}(Z-X\beta)  \} \tag{16}
\end{equation}\]</span></p>
<p>We maximize (16) w.r.t. <span class="math inline">\(\beta,\theta\)</span>. To reduce computation, we profile <span class="math inline">\(\beta\)</span> with GLS estimator and find the mle of <span class="math inline">\(\theta\)</span>. Finally, we get the mle of <span class="math inline">\(\beta\)</span>. Estimator using this method is called <em>empirical best linear unbiased predictor</em> (EBLUP).</p>
<p><strong>Bayesian Inference</strong><br />
Instead fixing <span class="math inline">\(\theta, \beta\)</span>, we set the prior on them in bayesian statistics. Because the closed form of posterior distribution is often not possible, we get the numerical evaluation of it.</p>
</div>
</div>
<div id="random-effects-parameterizations" class="section level2">
<h2><span class="header-section-number">4.3</span> Random-Effects Parameterizations</h2>
<p>Models including random-effects can take conditional or marginal approach depending on the purpose of analysis. If one specifies intercepts and slopes as random effects, inference at the subject (individual) level can be considered. In contrast, if the ficed treatment effects <span class="math inline">\(\beta\)</span> is the main interest, one might consider the marginal distribution of the responses where individual random effects have been integrated out. In spatial or spatio-temporal modeling, same considerations apply except that the random effects account for spatial or spatio-temporal effect. This is important in that it allows us to build spatio-temporal depdence conditionally, which allows us to build spatio-temporal dependence conditionally and some computational advantages. [See the technical note 4.3 in textbook for more details.]</p>
</div>
<div id="basis-function-representations" class="section level2">
<h2><span class="header-section-number">4.4</span> Basis-Function Representations</h2>
<p>We talked about basis function at chapter 1, 3. Similar to random effects, coefficient of basis functions can be fixed effect or andom effect. If we consider random effect, it can be spatial, temporal or spatio-temporal basis functions. We will see those in the following subsections.</p>
<div id="random-effects-with-spatio-temporal-basis-functionss" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Random Effects with Spatio-Temporal Basis Functionss</h3>
<p>Suppose the observation and process model in (3). We resrite the process model in terms of fixed and random effects, i.e.,</p>
<p><span class="math display">\[\begin{equation}
  Y(s;t) = \mathbf{x}(s;t)&#39; \beta + \eta(s;t) = \mathbf{x}(s;t)&#39; \beta + \sum^{n_\alpha}_{i=1} \phi_i(s;t)\alpha_i + \nu(s;t) \tag{17}
\end{equation}\]</span></p>
<p>Note that basis functions in (17) are functions of <span class="math inline">\(s,t\)</span>; <span class="math inline">\(\phi(s;t)\)</span>. The corresponding coefficient <span class="math inline">\(\alpha_i\)</span> is random effects. <span class="math inline">\(\nu(s;t)\)</span> is sometimes needed to represent small-scale spatio-temporal random effects not captured by the basis functions. That is, <em>the spatio-temporal random process, <span class="math inline">\(\eta(s;t)\)</span> is decomposed into a linear combination of <span class="math inline">\(n_\alpha\)</span> random effects and a residual error term</em>.<br />
Suppose <span class="math inline">\(\alpha \sim Gau(0, \mathbf{C}_\alpha)\)</span>, where <span class="math inline">\(\alpha \equiv (\alpha_1, \cdots, \alpha_{n_\alpha})\)</span>. In vector notation, the spatio-temporal process model can be represented as</p>
<p><span class="math display">\[\begin{equation}
  \mathbf{Y} = \mathbf{X\beta} + \mathbf{\Phi \alpha} + \mathbb{\nu} \tag{18}
\end{equation}\]</span></p>
<p>From technical note 4.3, the marginal distribution of <span class="math inline">\(\mathbf{Y}\)</span> is given by <span class="math inline">\(\mathbf{Y} \sim Gau(\mathbf{X}\beta, \mathbf{\Phi C_\alpha \Phi &#39;} + \mathbf{C_\nu})\)</span>. Benefit ot this approach is that we focus on fixed number of <span class="math inline">\(n_\alpha\)</span> random effects, which we set far less thatn <span class="math inline">\(n_y\)</span>, original dimension, for computational gain. Moreover, the covariance matrix of <span class="math inline">\(\mathbf{Z}\)</span>, the observation process, can be expressed as <span class="math inline">\(\mathbf{C_z} = \mathbf{\Phi C_\alpha \Phi &#39;} + \mathbf{C_\nu} + \mathbf{C}_\epsilon\)</span>, on which we can apply Sherman-Morrison-Woodbery matrix identities. Therefore, we can get great computation efficienccy.<br />
</p>
<p>Choices of basis functions can be tricky because there are many options for spatio-temporal basis functions; 1) fixed or parameterized basis functions, 2) local or global basis functions, 3) reduced-rank, complete, or over-complete bases, 4) basis functions with expansion coefficients possibly indexed by space, time or space-time. Moreover, the thoice is affected by the presence and type of residual structure and the distribution of the random effects, so it is not easy to use basis functions. One simple attempt could be tensor-product basis functions, where we define the spatio-temporal basis function as the product of a spatial basis function and a temporal basis function.<br />
</p>
<p><strong>Example: Fixed Rank Kriging</strong><br />
</p>
</div>
<div id="random-effects-with-spatial-basis-functions." class="section level3">
<h3><span class="header-section-number">4.4.2</span> Random Effects with Spatial Basis Functions.</h3>
<p>We can also consider the basis functions of space only and random coefficients indexed by time.</p>
<p><span class="math display">\[\begin{equation}
  Y(s;t) = \mathbf{x}(s;t)&#39; \beta + \eta(s;t) = \mathbf{x}(s;t)&#39; \beta + \sum^{n_\alpha}_{i=1} \phi_i(s)\alpha_i(t_j) + \nu(s;t) \tag{19}
\end{equation}\]</span></p>
<p>For spatial only basis model specified in (19), there are two options for <span class="math inline">\(\alpha\)</span>. One is independent assumption, i.e. <span class="math inline">\(\alpha_{t_1}, \alpha_{t_2}, \cdots\)</span>, which results in separable spatio-temporal dependence structure. The other is dependent assumption to model complex spatio-temporal dependence structure which will be discuseed in Chapter 5.</p>
</div>
<div id="random-effects-with-temporal-basis-functions" class="section level3">
<h3><span class="header-section-number">4.4.3</span> Random Effects with Temporal Basis Functions</h3>
<p>Finally, we can also express spatio-temporal random process in terms of temporal basis functions and spatially indexed random effects.
<span class="math display">\[\begin{equation}
  Y(s;t) = \mathbf{x}(s;t)&#39; \beta + \eta(s;t) = \mathbf{x}(s;t)&#39; \beta + \sum^{n_\alpha}_{i=1} \phi_i(t)\alpha_i(s) + \nu(s;t) \tag{20}
\end{equation}\]</span>
Model (20) is not as common as the model (18). However, the temporal basis functions are increasinly being used to model non-stationary-in-time processes that vary across space.<br />
</p>
<p><strong>Example Using Temporal Basis Functions</strong><br />
</p>
</div>
<div id="confounding-of-fixed-effects-and-random-effects" class="section level3">
<h3><span class="header-section-number">4.4.4</span> Confounding of Fixed Effects and Random Effects</h3>
<p>Consider general mixed-effects representation given in (18). The design matrix <span class="math inline">\(\mathbf{X}\)</span> is a function of space-time and matrix of basis function <span class="math inline">\(\mathbf{\Phi}\)</span> can also be a function of space-time. That is, there is a concern that there is a potential confounding associated with the random effects. For this reason, many people choose basis functions in <span class="math inline">\(\mathbf{\Phi}\)</span> orthogonal to the columns space of <span class="math inline">\(\mathbf{X}\)</span> to avoid this confounding. However, if one aims to predict the hidden process, this is not a problem at all.</p>
</div>
</div>
<div id="lab-package-frk" class="section level2">
<h2><span class="header-section-number">4.5</span> Lab: Package FRK</h2>
<p>We fit the maximum temperature from NOAA data using spatio-temporal basis functions. Amony many packages, we use the FRK package this lab. In fitting FRK model, there are some steps to follow.</p>
<ul>
<li>Create <em>basic areal units</em> (BAUs) whose primary utility is to account for problems of change of support. In paper, BAUs is explained as</li>
</ul>
<p><em>The BAU can be viewed as the smallest
spatial area or spatio-temporal volume that can be resolved by the process and, to reflect this,
the process itself is assumed to be piecewise constant over the set of BAUs. BAUs do not need to be square or all equal in size, but they do need to be ‘small,’
in the sense that they should be able to reconstruct the (undiscretised) process with minimal
error.</em></p>
<ul>
<li><p>After creating BAUs, we need to create basis function, which is essential part of the FRK.</p></li>
<li><p>Finally, we fit the model.</p></li>
</ul>
<p>First of all, let’s create BAUs and plot them to grasp what they are.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-1"></a><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb12-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-2"></a><span class="kw">library</span>(<span class="st">&quot;FRK&quot;</span>)</span>
<span id="cb12-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-3"></a><span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb12-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-4"></a><span class="kw">library</span>(<span class="st">&quot;gstat&quot;</span>)</span>
<span id="cb12-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-5"></a><span class="kw">library</span>(<span class="st">&quot;RColorBrewer&quot;</span>)</span>
<span id="cb12-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-6"></a><span class="kw">library</span>(<span class="st">&quot;sp&quot;</span>)</span>
<span id="cb12-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-7"></a><span class="kw">library</span>(<span class="st">&quot;spacetime&quot;</span>)</span>
<span id="cb12-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-8"></a><span class="kw">library</span>(<span class="st">&quot;STRbook&quot;</span>)</span>
<span id="cb12-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-9"></a><span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)</span>
<span id="cb12-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-10"></a></span>
<span id="cb12-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-11"></a><span class="kw">data</span>(<span class="st">&quot;STObj3&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>) <span class="co"># load STObj3</span></span>
<span id="cb12-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-12"></a>STObj4 &lt;-<span class="st"> </span>STObj3[, <span class="st">&quot;1993-07-01::1993-07-31&quot;</span>] <span class="co"># subset time</span></span>
<span id="cb12-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-13"></a>STObj5 &lt;-<span class="st"> </span><span class="kw">as</span>(STObj4[, <span class="dv">-14</span>], <span class="st">&quot;STIDF&quot;</span>) <span class="co"># omit t = 14</span></span>
<span id="cb12-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-14"></a>STObj5 &lt;-<span class="st"> </span><span class="kw">subset</span>(STObj5, <span class="op">!</span><span class="kw">is.na</span>(STObj5<span class="op">$</span>z)) <span class="co"># remove NAs</span></span>
<span id="cb12-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-15"></a></span>
<span id="cb12-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-16"></a>BAUs &lt;-<span class="st"> </span><span class="kw">auto_BAUs</span>(<span class="dt">manifold =</span> <span class="kw">STplane</span>(), <span class="co"># ST field on the plane</span></span>
<span id="cb12-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-17"></a><span class="dt">type =</span> <span class="st">&quot;grid&quot;</span>, <span class="co"># gridded (not &quot;hex&quot;)</span></span>
<span id="cb12-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-18"></a><span class="dt">data =</span> STObj5, <span class="co"># data</span></span>
<span id="cb12-19"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-19"></a><span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.75</span>, <span class="dv">1</span>), <span class="co"># BAU cell size</span></span>
<span id="cb12-20"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-20"></a><span class="dt">convex =</span> <span class="fl">-0.12</span>, <span class="co"># hull extension</span></span>
<span id="cb12-21"><a href="descriptive-spatio-temporal-statistical-models.html#cb12-21"></a><span class="dt">tunit =</span> <span class="st">&quot;days&quot;</span>) <span class="co"># time unit is &quot;days&quot;</span></span></code></pre></div>
<p>Note the cellsize argument of auto_BAUs determines the size of BAUs.</p>
<p>We can also use hexagone BAUs using following code.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-1"></a>BAUs_hex &lt;-<span class="st"> </span><span class="kw">auto_BAUs</span>(<span class="dt">manifold =</span> <span class="kw">STplane</span>(), <span class="co"># model on the plane</span></span>
<span id="cb13-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-2"></a><span class="dt">type =</span> <span class="st">&quot;hex&quot;</span>, <span class="co"># hex (not &quot;grid&quot;)</span></span>
<span id="cb13-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-3"></a><span class="dt">data =</span> STObj5, <span class="co"># data</span></span>
<span id="cb13-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-4"></a><span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.75</span>, <span class="dv">1</span>), <span class="co"># BAU cell size</span></span>
<span id="cb13-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-5"></a><span class="dt">nonconvex_hull =</span> <span class="ot">FALSE</span>, <span class="co"># convex hull</span></span>
<span id="cb13-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-6"></a><span class="dt">tunit =</span> <span class="st">&quot;days&quot;</span>) <span class="co"># time unit is &quot;days&quot;</span></span>
<span id="cb13-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-7"></a></span>
<span id="cb13-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-8"></a><span class="kw">plot</span>(<span class="kw">as</span>(BAUs[, <span class="dv">1</span>], <span class="st">&quot;SpatialPixels&quot;</span>)) <span class="co"># plot pixel BAUs</span></span>
<span id="cb13-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-9"></a><span class="kw">plot</span>(<span class="kw">SpatialPoints</span>(STObj5),</span>
<span id="cb13-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb13-10"></a><span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="co"># plot data points</span></span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb14-1"></a><span class="kw">plot</span>(<span class="kw">as</span>(BAUs_hex[, <span class="dv">1</span>], <span class="st">&quot;SpatialPolygons&quot;</span>))</span>
<span id="cb14-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb14-2"></a><span class="kw">plot</span>(<span class="kw">SpatialPoints</span>(STObj5),</span>
<span id="cb14-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb14-3"></a><span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="co"># plot data points</span></span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<p>Some grids are made above to include data points.<br />
</p>
<p>Next, we create spatio-temporal basis functions. In <span class="math inline">\(\texttt{FRK}\)</span>, basis functions are created by taking the tesnor product of spatial basis functions and temporal basis functions. That is, $_p(s)_q(t); ; p=1,,r_s, $ <span class="math inline">\(q=1,\cdots,r_t\)</span>. Basis function can be either regularly placed, or irregularly placed and they are often multi-resolutional. After <span class="math inline">\(\texttt{auto_basis}\)</span>, we automatically get number of basis function, in this case, <span class="math inline">\(r_s = 94\)</span>, and bisquare apertures.<br />
Next, we create 20 temporal basis functions so that tensor producting them results in total number of spatio-temporal basis functions is <span class="math inline">\(r_s r_t = 1880\)</span>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-1"></a>G_spatial &lt;-<span class="st"> </span><span class="kw">auto_basis</span>(<span class="dt">manifold =</span> <span class="kw">plane</span>(),      <span class="co"># fns on plane</span></span>
<span id="cb15-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-2"></a>                        <span class="dt">data =</span> <span class="kw">as</span>(STObj5, <span class="st">&quot;Spatial&quot;</span>), <span class="co"># project</span></span>
<span id="cb15-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-3"></a>                        <span class="dt">nres =</span> <span class="dv">2</span>,                     <span class="co"># 2 res.</span></span>
<span id="cb15-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-4"></a>                        <span class="dt">type =</span> <span class="st">&quot;bisquare&quot;</span>,            <span class="co"># bisquare.</span></span>
<span id="cb15-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-5"></a>                        <span class="dt">regular =</span> <span class="dv">0</span>)                  <span class="co"># irregular</span></span>
<span id="cb15-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-6"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb15-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-7"></a>t_grid &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">31</span>, <span class="dt">length =</span> <span class="dv">20</span>))</span>
<span id="cb15-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-8"></a></span>
<span id="cb15-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-9"></a>G_temporal &lt;-<span class="st"> </span><span class="kw">local_basis</span>(<span class="dt">manifold =</span> <span class="kw">real_line</span>(), <span class="co"># fns on R1</span></span>
<span id="cb15-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-10"></a><span class="dt">type =</span> <span class="st">&quot;bisquare&quot;</span>, <span class="co"># bisquare</span></span>
<span id="cb15-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-11"></a><span class="dt">loc =</span> t_grid, <span class="co"># centroids</span></span>
<span id="cb15-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-12"></a><span class="dt">scale =</span> <span class="kw">rep</span>(<span class="dv">2</span>, <span class="dv">20</span>)) <span class="co"># aperture par.</span></span>
<span id="cb15-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-13"></a></span>
<span id="cb15-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb15-14"></a>G &lt;-<span class="st"> </span><span class="kw">TensorP</span>(G_spatial, G_temporal) <span class="co"># take the tensor product</span></span></code></pre></div>
<p>Note that although spatio-temporal basis functions are generated from tensor product, resulting S-T covariance function is not separable.<br />
In this lab, we assume the measurement error variance is the nugget estimated when fitting the separable covariance function. (?) Finally, we fit the FRK model.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-1"></a>STObj5<span class="op">$</span>std =<span class="st"> </span><span class="kw">sqrt</span>(<span class="fl">0.049</span>)</span>
<span id="cb16-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-2"></a>f =<span class="st"> </span>z <span class="op">~</span><span class="st"> </span>lat <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb16-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-3"></a></span>
<span id="cb16-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-4"></a>S &lt;-<span class="st"> </span><span class="kw">FRK</span>(<span class="dt">f =</span> f, <span class="co"># formula</span></span>
<span id="cb16-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-5"></a><span class="dt">data =</span> <span class="kw">list</span>(STObj5), <span class="co"># (list of) data</span></span>
<span id="cb16-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-6"></a><span class="dt">basis =</span> G, <span class="co"># basis functions</span></span>
<span id="cb16-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-7"></a><span class="dt">BAUs =</span> BAUs, <span class="co"># BAUs</span></span>
<span id="cb16-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-8"></a><span class="dt">n_EM =</span> <span class="dv">3</span>, <span class="co"># max. no. of EM iterations</span></span>
<span id="cb16-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb16-9"></a><span class="dt">tol =</span> <span class="fl">0.01</span>) <span class="co"># tol. on change in log-likelihood</span></span></code></pre></div>
<pre><code>## std already supplied with data -- not estimating the measurement error.
##               If you wish to estimate measurement error then set the std field to NULL
## Assuming fine-scale variation is homoscedastic
## Modelling using 1880 basis functions
## Constructing SRE model...
## Normalising basis function evaluations at BAU level ...
## Binning data ...
## Binned data in 0.102 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.034 seconds
## Binned data in 0.034 seconds
## Binned data in 0.033 seconds
## Binned data in 0.037 seconds
## Binned data in 0.037 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.034 seconds
## Binned data in 0.034 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.032 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Binned data in 0.034 seconds
## Binned data in 0.033 seconds
## Binned data in 0.034 seconds
## Fitting SRE model...
## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |======================================================================| 100%
## Maximum EM iterations reached</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb18-1"></a>grid_BAUs =<span class="st"> </span><span class="kw">predict</span>(S)</span>
<span id="cb18-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb18-2"></a><span class="kw">stplot</span>(grid_BAUs)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="lab-non-gaussian-spatio-temporal-gams-with-mgvv" class="section level2">
<h2><span class="header-section-number">4.6</span> Lab: Non-Gaussian Spatio-Temporal GAMs with mgvv</h2>
<p>In this lab, we aim to predict the expected bird counts at arbitrary spatio-temporal locations. The Carolina wren counts data will be used using GAMs and GAMMs.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb19-1"></a><span class="kw">library</span>(<span class="st">&quot;mgcv&quot;</span>)</span>
<span id="cb19-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb19-2"></a><span class="kw">data</span>(<span class="st">&quot;MOcarolinawren_long&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</span></code></pre></div>
<p>To do GAMs, GAMMs, we assume following models</p>
<p><span class="math display">\[\begin{equation}
  g(Y(s;t)) = \beta + f(s;t) + \nu(s;t) \tag{21}
\end{equation}\]</span></p>
<p>where
* <span class="math inline">\(g\)</span> is link function because we assume generalized models,
* <span class="math inline">\(\beta\)</span> is an intercept
* <span class="math inline">\(f(s;t)\)</span> is a random smooth function of space and time,
* <span class="math inline">\(\nu(s;t)\)</span> is a spatio-temporal white-noise error process</p>
<p>In <strong>mgcv</strong>, it should be noted that the random smooth function <span class="math inline">\(f\)</span> is decomposed into spline basis, ie., <span class="math inline">\(\sum^{r_1}_{i=1}\)</span> <em>{1i}(s;t)</em>{1i} and <span class="math inline">\(\alpha_{1i}\)</span> are unknown random effects that need to be predicted. As done before, the spline basis are known function. The <em>thin-plate regression splines</em> are usually used, as they are easily amenable to multiple covariates. However, using this basis function over <em>both space and time</em> is not recommended. Therefore, similar to <span class="math inline">\(\texttt{FRK}\)</span> package, we use tensor product for basis function of space and time. That is,</p>
<p><span class="math display">\[\begin{equation}
  f(s;t) = \sum^{r_1}_{i=1} \sum^{r_2}_{j=1} \phi_{1i}(s) \phi_{2j}(t) \alpha_{ij} \equiv \boldsymbol{\phi^{&#39;}\alpha} \tag{22}
\end{equation}\]</span></p>
<p>The function <span class="math inline">\(\texttt{te}\)</span> forms the product from the marginals. We employ thin-plate spline basis over space(longitude, latitude) and a cubic regression spline over time through <span class="math inline">\(\texttt{tp, cr}\)</span>. We negative binomial model to adjust the overdispersion.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb20-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-2"></a>f &lt;-<span class="st"> </span>cnt <span class="op">~</span><span class="st"> </span><span class="kw">te</span>(lon, lat, t,         <span class="co"># inputs over which to smooth</span></span>
<span id="cb20-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-3"></a>              <span class="dt">bs =</span> <span class="kw">c</span>(<span class="st">&quot;tp&quot;</span>, <span class="st">&quot;cr&quot;</span>),  <span class="co"># types of bases</span></span>
<span id="cb20-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-4"></a>              <span class="dt">k =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">10</span>),       <span class="co"># knot count in each dimension</span></span>
<span id="cb20-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-5"></a>              <span class="dt">d =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))         <span class="co"># (s,t) basis dimension</span></span>
<span id="cb20-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-6"></a></span>
<span id="cb20-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-7"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb20-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-8"></a>cnts &lt;-<span class="st"> </span><span class="kw">gam</span>(f, <span class="dt">family =</span> <span class="kw">nb</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb20-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-9"></a>             <span class="dt">data =</span> MOcarolinawren_long)</span>
<span id="cb20-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-10"></a></span>
<span id="cb20-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-11"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb20-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb20-12"></a>cnts<span class="op">$</span>family<span class="op">$</span><span class="kw">getTheta</span>(<span class="dt">trans =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 5.178305</code></pre>
<p>Note relatively small parameter <span class="math inline">\(r\)</span> estimated from the model, which means that negative binomial model is appropriate.<br />
Next, to predict the field at unobserved locations using the hierarchical model, we create space-time grid as</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb22-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-2"></a>MOlon &lt;-<span class="st"> </span>MOcarolinawren_long<span class="op">$</span>lon</span>
<span id="cb22-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-3"></a>MOlat &lt;-<span class="st"> </span>MOcarolinawren_long<span class="op">$</span>lat</span>
<span id="cb22-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-4"></a></span>
<span id="cb22-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-5"></a><span class="co">## Construct space-time grid</span></span>
<span id="cb22-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-6"></a>grid_locs &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">lon =</span> <span class="kw">seq</span>(<span class="kw">min</span>(MOlon) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb22-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-7"></a>                                   <span class="kw">max</span>(MOlon) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb22-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-8"></a>                                   <span class="dt">length.out =</span> <span class="dv">80</span>),</span>
<span id="cb22-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-9"></a>                         <span class="dt">lat =</span> <span class="kw">seq</span>(<span class="kw">min</span>(MOlat) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb22-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-10"></a>                                   <span class="kw">max</span>(MOlat) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb22-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-11"></a>                                   <span class="dt">length.out =</span> <span class="dv">80</span>),</span>
<span id="cb22-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-12"></a>                         <span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">max</span>(MOcarolinawren_long<span class="op">$</span>t))</span>
<span id="cb22-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-13"></a></span>
<span id="cb22-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-14"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb22-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb22-15"></a>X &lt;-<span class="st"> </span><span class="kw">predict</span>(cnts, grid_locs, <span class="dt">se.fit =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Now we predict the bird count at prediction space-time grid. The results are shown with the standard error plot.</p>
</div>
<div id="non-gaussian-spatio-temporal-models-with-inla" class="section level2">
<h2><span class="header-section-number">4.7</span> Non-Gaussian Spatio-Temporal Models with INLA</h2>
<p>Integrated Nested Laplace Approximation (INLA) is an approximation method to get samples from marginals of posteriors instead of joint of posteriors. Its main idea is that because deriving joint posterior distribution through MCMC consumes lots of time, instead it suggests to get samples from marginal posterior distribution. More details will be found on their paper. We focus on the implementation of INLA in R on the Carolina wren counts data</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb23-1"></a><span class="kw">library</span>(<span class="st">&quot;INLA&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:tidyr&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## This is INLA_20.03.17 built 2020-06-14 16:50:48 UTC.
## See www.r-inla.org/contact-us for how to get help.
## To enable PARDISO sparse library; see inla.pardiso()</code></pre>
<p>We consider the same negative binomial model similar to previous lab. This time, we write data model as matrix notation,
<span class="math display">\[\begin{equation}
  Z_t \mid Y_t \sim indep \; NB(Y_t, r) \tag{23}
\end{equation}\]</span>
and the process model as,
<span class="math display">\[\begin{equation}
  log Y_t = X_t \beta + \Phi_t \alpha_t \tag{24}
\end{equation}\]</span></p>
<ul>
<li><span class="math inline">\(Z_t\)</span> is an <span class="math inline">\(m_t\)</span> dimensional data vector of counts at <span class="math inline">\(m_t\)</span> spatial locations</li>
<li><span class="math inline">\(E(Z_t \mid Y_t) = Y_t\)</span>, which means <span class="math inline">\(Y_t\)</span> represents the latent spatio-temporal mean process.</li>
<li><span class="math inline">\(\Phi_t\)</span> is an <span class="math inline">\(m_t \times n_\alpha\)</span> dimensional spatial basis functions</li>
<li><span class="math inline">\(\alpha_t\)</span> is random coefficient which follow <span class="math inline">\(Gau(0, C_\alpha)\)</span></li>
</ul>
<p>In <span class="math inline">\(\texttt{FRK}\)</span> package, we use BAUs as basis function. In <span class="math inline">\(\texttt{INLA}\)</span>, we use <strong>mesh</strong>, triangulation of the domain, as basis functions. To establish this, we invoke following code.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb30-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-2"></a>coords &lt;-<span class="st"> </span><span class="kw">unique</span>(MOcarolinawren_long[<span class="kw">c</span>(<span class="st">&quot;loc.ID&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)])</span>
<span id="cb30-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-3"></a>boundary &lt;-<span class="st"> </span><span class="kw">inla.nonconvex.hull</span>(<span class="kw">as.matrix</span>(coords[, <span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]))</span>
<span id="cb30-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-4"></a></span>
<span id="cb30-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-5"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb30-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-6"></a>MOmesh &lt;-<span class="st"> </span><span class="kw">inla.mesh.2d</span>(<span class="dt">boundary =</span> boundary,</span>
<span id="cb30-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-7"></a>                       <span class="dt">max.edge =</span> <span class="kw">c</span>(<span class="fl">0.8</span>, <span class="fl">1.2</span>), <span class="co"># max. edge length</span></span>
<span id="cb30-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-8"></a>                       <span class="dt">cutoff =</span> <span class="fl">0.1</span>)           <span class="co"># min. edge length</span></span>
<span id="cb30-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-9"></a></span>
<span id="cb30-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-10"></a><span class="kw">plot</span>(MOmesh,<span class="dt">asp=</span><span class="dv">1</span>,<span class="dt">main=</span><span class="st">&quot;&quot;</span>);</span>
<span id="cb30-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb30-11"></a><span class="kw">lines</span>(coords[<span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;lat&quot;</span>)],<span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">type=</span><span class="st">&quot;p&quot;</span>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>When using INLA, the covariance matrix of <span class="math inline">\(\alpha\)</span> is chosen toe be separable across space and time.</p>
<p><span class="math display">\[\begin{equation}
  \Sigma_t(\rho) \otimes \Sigma_s (\tau, \kappa, \nu) \tag{25}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\rho\)</span> is AR parameter, <span class="math inline">\(\tau, \kappa, \nu\)</span> are estimated as a solution to the stochastic partial differential equation (SPDE)</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb31-1"></a>spde &lt;-<span class="st"> </span><span class="kw">inla.spde2.pcmatern</span>(<span class="dt">mesh =</span> MOmesh,</span>
<span id="cb31-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb31-2"></a>                            <span class="dt">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb31-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb31-3"></a>                            <span class="dt">prior.range =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>),</span>
<span id="cb31-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb31-4"></a>                            <span class="dt">prior.sigma =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="fl">0.01</span>))</span></code></pre></div>
<p>We make the space-time index needed for block-matrix structure in INLA. After that, we make matrix <span class="math inline">\(\Phi\)</span>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb32-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-2"></a>n_years &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(MOcarolinawren_long<span class="op">$</span>t))</span>
<span id="cb32-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-3"></a>n_spatial &lt;-<span class="st"> </span>MOmesh<span class="op">$</span>n</span>
<span id="cb32-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-4"></a>s_index &lt;-<span class="st"> </span><span class="kw">inla.spde.make.index</span>(<span class="dt">name =</span> <span class="st">&quot;spatial.field&quot;</span>,</span>
<span id="cb32-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-5"></a>                                <span class="dt">n.spde =</span> n_spatial,</span>
<span id="cb32-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-6"></a>                                <span class="dt">n.group =</span> n_years)</span>
<span id="cb32-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-7"></a></span>
<span id="cb32-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-8"></a></span>
<span id="cb32-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-9"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb32-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-10"></a>coords.allyear &lt;-<span class="st"> </span>MOcarolinawren_long[<span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)] <span class="op">%&gt;%</span></span>
<span id="cb32-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-11"></a><span class="st">                  </span><span class="kw">as.matrix</span>()</span>
<span id="cb32-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-12"></a>PHI &lt;-<span class="st"> </span><span class="kw">inla.spde.make.A</span>(<span class="dt">mesh =</span> MOmesh,</span>
<span id="cb32-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-13"></a>                        <span class="dt">loc =</span> coords.allyear,</span>
<span id="cb32-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-14"></a>                        <span class="dt">group =</span> MOcarolinawren_long<span class="op">$</span>t,</span>
<span id="cb32-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-15"></a>                        <span class="dt">n.group =</span> n_years)</span>
<span id="cb32-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-16"></a></span>
<span id="cb32-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-17"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb32-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb32-18"></a><span class="kw">dim</span>(PHI)</span></code></pre></div>
<pre><code>## [1] 1575 5439</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb34-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb34-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb34-2"></a><span class="kw">nrow</span>(MOcarolinawren_long)</span></code></pre></div>
<pre><code>## [1] 1575</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb36-1"></a><span class="kw">length</span>(s_index<span class="op">$</span>spatial.field)</span></code></pre></div>
<pre><code>## [1] 5439</code></pre>
<p>We construct the latent Gaussian model in INLA using <em>stack</em>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-1"></a><span class="co">## First stack: Estimation</span></span>
<span id="cb38-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-2"></a>n_data &lt;-<span class="st"> </span><span class="kw">nrow</span>(MOcarolinawren_long)</span>
<span id="cb38-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-3"></a>stack_est &lt;-<span class="st"> </span><span class="kw">inla.stack</span>(</span>
<span id="cb38-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-4"></a>                 <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">cnt =</span> MOcarolinawren_long<span class="op">$</span>cnt),</span>
<span id="cb38-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-5"></a>                 <span class="dt">A =</span> <span class="kw">list</span>(PHI, <span class="dv">1</span>),</span>
<span id="cb38-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-6"></a>                 <span class="dt">effects =</span> <span class="kw">list</span>(s_index,</span>
<span id="cb38-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-7"></a>                                <span class="kw">list</span>(<span class="dt">Intercept =</span> <span class="kw">rep</span>(<span class="dv">1</span>, n_data))),</span>
<span id="cb38-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-8"></a>                 <span class="dt">tag =</span> <span class="st">&quot;est&quot;</span>)</span>
<span id="cb38-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-9"></a></span>
<span id="cb38-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-10"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb38-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-11"></a>df_pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">lon =</span> <span class="kw">rep</span>(MOmesh<span class="op">$</span>loc[,<span class="dv">1</span>], n_years),</span>
<span id="cb38-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-12"></a>                      <span class="dt">lat =</span> <span class="kw">rep</span>(MOmesh<span class="op">$</span>loc[,<span class="dv">2</span>], n_years),</span>
<span id="cb38-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-13"></a>                      <span class="dt">t =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n_years, <span class="dt">each =</span> MOmesh<span class="op">$</span>n))</span>
<span id="cb38-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-14"></a>n_pred &lt;-<span class="st"> </span><span class="kw">nrow</span>(df_pred)</span>
<span id="cb38-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-15"></a>PHI_pred &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="dt">n =</span> n_pred)</span>
<span id="cb38-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-16"></a></span>
<span id="cb38-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-17"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb38-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-18"></a><span class="co">## Second stack: Prediction</span></span>
<span id="cb38-19"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-19"></a>stack_pred &lt;-<span class="st"> </span><span class="kw">inla.stack</span>(</span>
<span id="cb38-20"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-20"></a>                 <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">cnt =</span> <span class="ot">NA</span>),</span>
<span id="cb38-21"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-21"></a>                 <span class="dt">A =</span> <span class="kw">list</span>(PHI_pred, <span class="dv">1</span>),</span>
<span id="cb38-22"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-22"></a>                 <span class="dt">effects =</span> <span class="kw">list</span>(s_index,</span>
<span id="cb38-23"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-23"></a>                                <span class="kw">list</span>(<span class="dt">Intercept =</span> <span class="kw">rep</span>(<span class="dv">1</span>, n_pred))),</span>
<span id="cb38-24"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-24"></a>                 <span class="dt">tag =</span> <span class="st">&quot;pred&quot;</span>)</span>
<span id="cb38-25"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-25"></a></span>
<span id="cb38-26"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-26"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb38-27"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-27"></a>stack &lt;-<span class="st"> </span><span class="kw">inla.stack</span>(stack_est, stack_pred)</span>
<span id="cb38-28"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-28"></a></span>
<span id="cb38-29"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-29"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb38-30"><a href="descriptive-spatio-temporal-statistical-models.html#cb38-30"></a><span class="kw">dim</span>(stack_est<span class="op">$</span>A)</span></code></pre></div>
<pre><code>## [1] 1575 1702</code></pre>
<p>Now, we are left with specifying the formula of model.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-1"></a><span class="co">## PC prior on rho</span></span>
<span id="cb40-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-2"></a>rho_hyper &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta=</span><span class="kw">list</span>(<span class="dt">prior =</span> <span class="st">&#39;pccor1&#39;</span>,</span>
<span id="cb40-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-3"></a>                             <span class="dt">param =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.9</span>)))</span>
<span id="cb40-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-4"></a></span>
<span id="cb40-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-5"></a><span class="co">## Formula</span></span>
<span id="cb40-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-6"></a>formula &lt;-<span class="st"> </span>cnt <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>Intercept <span class="op">+</span></span>
<span id="cb40-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-7"></a><span class="st">                 </span><span class="kw">f</span>(spatial.field,</span>
<span id="cb40-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-8"></a>                   <span class="dt">model =</span> spde,</span>
<span id="cb40-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-9"></a>                   <span class="dt">group =</span> spatial.field.group,</span>
<span id="cb40-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-10"></a>                   <span class="dt">control.group =</span> <span class="kw">list</span>(<span class="dt">model =</span> <span class="st">&quot;ar1&quot;</span>,</span>
<span id="cb40-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb40-11"></a>                                        <span class="dt">hyper =</span> rho_hyper))</span></code></pre></div>
<p>Finally let’s fit INLA model!!</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb41-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-2"></a><span class="co">## output &lt;- inla(formula,</span></span>
<span id="cb41-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-3"></a><span class="co">##                data = inla.stack.data(stack, spde = spde),</span></span>
<span id="cb41-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-4"></a><span class="co">##                family = &quot;nbinomial&quot;,</span></span>
<span id="cb41-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-5"></a><span class="co">##                control.predictor = list(A = inla.stack.A(stack),</span></span>
<span id="cb41-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-6"></a><span class="co">##                                         compute = TRUE))</span></span>
<span id="cb41-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-7"></a><span class="co">##</span></span>
<span id="cb41-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-8"></a><span class="co">## output2 &lt;- list(summary.fixed = output$summary.fixed,</span></span>
<span id="cb41-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-9"></a><span class="co">##                 summary.hyperpar = output$summary.hyperpar,</span></span>
<span id="cb41-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-10"></a><span class="co">##                 summary.fitted.values = output$summary.fitted.values,</span></span>
<span id="cb41-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-11"></a><span class="co">##                 marginals.fixed = output$marginals.fixed,</span></span>
<span id="cb41-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-12"></a><span class="co">##                 marginals.hyperpar = output$marginals.hyperpar,</span></span>
<span id="cb41-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-13"></a><span class="co">##                 internal.marginals.hyperpar = output$internal.marginals.hyperpar,</span></span>
<span id="cb41-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-14"></a><span class="co">##                 marginals.spde2.blc = output$marginals.spde2.blc,</span></span>
<span id="cb41-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-15"></a><span class="co">##                 marginals.spde3.blc = output$marginals.spde3.blc,</span></span>
<span id="cb41-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-16"></a><span class="co">##                 internal.marginals.hyperpar = output$internal.marginals.hyperpar)</span></span>
<span id="cb41-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-17"></a><span class="co">## class(output2) &lt;- &quot;inla&quot;</span></span>
<span id="cb41-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-18"></a><span class="co">## output &lt;- output2</span></span>
<span id="cb41-19"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-19"></a></span>
<span id="cb41-20"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-20"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb41-21"><a href="descriptive-spatio-temporal-statistical-models.html#cb41-21"></a><span class="kw">data</span>(<span class="st">&quot;INLA_output&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;STRbook&quot;</span>)</span></code></pre></div>
<p>This book provides the trained model, so let’s use it. As mentioned before, INLA provides marginal posterior distribution for each parameters not joint posterior distribution.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb42-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-2"></a><span class="kw">par</span>(<span class="dt">mgp=</span><span class="kw">c</span>(<span class="fl">2.2</span>,<span class="fl">0.45</span>,<span class="dv">0</span>), <span class="dt">tcl=</span><span class="op">-</span><span class="fl">0.4</span>, <span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">3.3</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb42-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-3"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb42-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-4"></a>output.field &lt;-<span class="st"> </span><span class="kw">inla.spde2.result</span>(<span class="dt">inla =</span> output,</span>
<span id="cb42-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-5"></a>                                  <span class="dt">name =</span> <span class="st">&quot;spatial.field&quot;</span>,</span>
<span id="cb42-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-6"></a>                                  <span class="dt">spde =</span> spde,</span>
<span id="cb42-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-7"></a>                                  <span class="dt">do.transf =</span> <span class="ot">TRUE</span>)</span>
<span id="cb42-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-8"></a><span class="kw">plot</span>(output<span class="op">$</span>marginals.fix[[<span class="dv">1</span>]],<span class="dt">type =</span><span class="st">&#39;l&#39;</span>,<span class="dt">xlab=</span><span class="kw">expression</span>(beta[<span class="dv">0</span>]),<span class="dt">ylab=</span><span class="kw">expression</span>(<span class="kw">p</span>(beta[<span class="dv">0</span>]<span class="op">*</span><span class="st">&quot;|&quot;</span><span class="op">*</span>Z)))</span>
<span id="cb42-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-9"></a><span class="kw">plot</span>(output<span class="op">$</span>marginals.hyperpar[[<span class="dv">4</span>]],<span class="dt">type =</span> <span class="st">&#39;l&#39;</span>,<span class="dt">xlab =</span> <span class="kw">expression</span>(rho),<span class="dt">ylab =</span> <span class="kw">expression</span>(<span class="kw">p</span>(rho<span class="op">*</span><span class="st">&quot;|&quot;</span><span class="op">*</span>Z)))</span>
<span id="cb42-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-10"></a><span class="kw">plot</span>(output.field<span class="op">$</span>marginals.variance.nominal[[<span class="dv">1</span>]],<span class="dt">type =</span> <span class="st">&#39;l&#39;</span>,<span class="dt">xlab =</span> <span class="kw">expression</span>(sigma<span class="op">^</span><span class="dv">2</span>),<span class="dt">ylab =</span> <span class="kw">expression</span>(<span class="kw">p</span>(sigma<span class="op">^</span><span class="dv">2</span><span class="op">*</span><span class="st">&quot;|&quot;</span><span class="op">*</span>Z)))</span>
<span id="cb42-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb42-11"></a><span class="kw">plot</span>(output.field<span class="op">$</span>marginals.range.nominal[[<span class="dv">1</span>]],<span class="dt">type =</span> <span class="st">&#39;l&#39;</span>,<span class="dt">xlab =</span> <span class="kw">expression</span>(l),<span class="dt">ylab =</span> <span class="kw">expression</span>(<span class="kw">p</span>(l<span class="op">*</span><span class="st">&quot;|&quot;</span><span class="op">*</span>Z)))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>Note the marginal posterior distribution of <span class="math inline">\(\sigma^2\)</span>. The mode is between 2 and 4 which is quite large. In other words, the spatio-temporal model we build is quite reasonable for this data. Also, the marginal distribution of <span class="math inline">\(\rho\)</span> is quite skewed to 1, which means AR(1) assumption is also reasonable to this data. Finally, we plot the spatial map filled with prediction values and standard error.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-1"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-2"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-2"></a>index_pred &lt;-<span class="st"> </span><span class="kw">inla.stack.index</span>(stack, <span class="st">&quot;pred&quot;</span>)<span class="op">$</span>data</span>
<span id="cb43-3"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-3"></a>lp_mean &lt;-<span class="st"> </span>output<span class="op">$</span>summary.fitted.values<span class="op">$</span>mean[index_pred]</span>
<span id="cb43-4"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-4"></a>lp_sd &lt;-<span class="st"> </span>output<span class="op">$</span>summary.fitted.values<span class="op">$</span>sd[index_pred]</span>
<span id="cb43-5"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-5"></a></span>
<span id="cb43-6"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-6"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-7"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-7"></a>grid_locs &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</span>
<span id="cb43-8"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-8"></a>                 <span class="dt">lon =</span> <span class="kw">seq</span>(<span class="kw">min</span>(MOcarolinawren_long<span class="op">$</span>lon) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-9"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-9"></a>                           <span class="kw">max</span>(MOcarolinawren_long<span class="op">$</span>lon) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-10"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-10"></a>                           <span class="dt">length.out =</span> <span class="dv">80</span>),</span>
<span id="cb43-11"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-11"></a>                 <span class="dt">lat =</span> <span class="kw">seq</span>(<span class="kw">min</span>(MOcarolinawren_long<span class="op">$</span>lat) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-12"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-12"></a>                           <span class="kw">max</span>(MOcarolinawren_long<span class="op">$</span>lat) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-13"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-13"></a>                           <span class="dt">length.out =</span> <span class="dv">80</span>))</span>
<span id="cb43-14"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-14"></a></span>
<span id="cb43-15"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-15"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-16"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-16"></a>proj.grid &lt;-<span class="st"> </span><span class="kw">inla.mesh.projector</span>(MOmesh,</span>
<span id="cb43-17"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-17"></a>                    <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(MOcarolinawren_long<span class="op">$</span>lon) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-18"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-18"></a>                             <span class="kw">max</span>(MOcarolinawren_long<span class="op">$</span>lon) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>),</span>
<span id="cb43-19"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-19"></a>                    <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(MOcarolinawren_long<span class="op">$</span>lat) <span class="op">-</span><span class="st"> </span><span class="fl">0.2</span>,</span>
<span id="cb43-20"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-20"></a>                             <span class="kw">max</span>(MOcarolinawren_long<span class="op">$</span>lat) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span>),</span>
<span id="cb43-21"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-21"></a>                    <span class="dt">dims =</span> <span class="kw">c</span>(<span class="dv">80</span>, <span class="dv">80</span>))</span>
<span id="cb43-22"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-22"></a></span>
<span id="cb43-23"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-23"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-24"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-24"></a>pred &lt;-<span class="st"> </span>sd &lt;-<span class="st">  </span><span class="ot">NULL</span></span>
<span id="cb43-25"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-25"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_years) {</span>
<span id="cb43-26"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-26"></a>    ii &lt;-<span class="st"> </span>(i<span class="dv">-1</span>)<span class="op">*</span>MOmesh<span class="op">$</span>n <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb43-27"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-27"></a>    jj &lt;-<span class="st"> </span>i<span class="op">*</span>MOmesh<span class="op">$</span>n</span>
<span id="cb43-28"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-28"></a>    pred[[i]] &lt;-<span class="st"> </span><span class="kw">cbind</span>(grid_locs,</span>
<span id="cb43-29"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-29"></a>                       <span class="dt">z =</span> <span class="kw">c</span>(<span class="kw">inla.mesh.project</span>(proj.grid,</span>
<span id="cb43-30"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-30"></a>                                             lp_mean[ii<span class="op">:</span>jj])),</span>
<span id="cb43-31"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-31"></a>                       <span class="dt">t =</span> i)</span>
<span id="cb43-32"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-32"></a>    sd[[i]] &lt;-<span class="st"> </span><span class="kw">cbind</span>(grid_locs,</span>
<span id="cb43-33"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-33"></a>                     <span class="dt">z =</span> <span class="kw">c</span>(<span class="kw">inla.mesh.project</span>(proj.grid,</span>
<span id="cb43-34"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-34"></a>                                             lp_sd[ii<span class="op">:</span>jj])),</span>
<span id="cb43-35"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-35"></a>                     <span class="dt">t =</span> i)</span>
<span id="cb43-36"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-36"></a>}</span>
<span id="cb43-37"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-37"></a></span>
<span id="cb43-38"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-38"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-39"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-39"></a>pred &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, pred) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(z))</span>
<span id="cb43-40"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-40"></a>sd &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, sd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(z))</span>
<span id="cb43-41"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-41"></a></span>
<span id="cb43-42"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-42"></a><span class="co">## ------------------------------------------------------------------------</span></span>
<span id="cb43-43"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-43"></a>df_tot &lt;-<span class="st"> </span><span class="kw">group_by</span>(MOcarolinawren_long,lon,lat) <span class="op">%&gt;%</span></span>
<span id="cb43-44"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-44"></a><span class="st">          </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">tot_cnt =</span> <span class="kw">sum</span>(cnt,<span class="dt">na.rm=</span>T))</span>
<span id="cb43-45"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-45"></a></span>
<span id="cb43-46"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-46"></a>g1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>(<span class="dt">data=</span>pred,<span class="kw">aes</span>(lon,lat,<span class="dt">fill=</span><span class="kw">pmin</span>(z,<span class="dv">5</span>))) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>t,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">ncol=</span><span class="dv">7</span>) <span class="op">+</span></span>
<span id="cb43-47"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-47"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">filter</span>(MOcarolinawren_long,<span class="op">!</span><span class="kw">is.na</span>(cnt)),<span class="kw">aes</span>(lon,lat),<span class="dt">colour=</span><span class="st">&quot;black&quot;</span>,<span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb43-48"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-48"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">filter</span>(MOcarolinawren_long,<span class="op">!</span><span class="kw">is.na</span>(cnt)),<span class="kw">aes</span>(lon,lat,<span class="dt">colour=</span><span class="kw">log</span>(cnt)),<span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb43-49"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-49"></a><span class="st">    </span><span class="kw">scale_colour_distiller</span>(<span class="dt">palette=</span><span class="st">&quot;Spectral&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb43-50"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-50"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">palette=</span><span class="st">&quot;Spectral&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">5</span>),<span class="dt">name=</span><span class="kw">expression</span>(<span class="kw">log</span>(Y[t]))) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()</span>
<span id="cb43-51"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-51"></a></span>
<span id="cb43-52"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-52"></a>g2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>(<span class="dt">data=</span>sd,<span class="kw">aes</span>(lon,lat,<span class="dt">fill=</span>z)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>t,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">ncol=</span><span class="dv">7</span>) <span class="op">+</span></span>
<span id="cb43-53"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-53"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">palette=</span><span class="st">&quot;BrBG&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">2.5</span>),<span class="dt">name=</span><span class="kw">expression</span>(s.e.)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()</span>
<span id="cb43-54"><a href="descriptive-spatio-temporal-statistical-models.html#cb43-54"></a><span class="kw">grid.arrange</span>(g1,g2)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatio-temporal-statistical-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="dynamic-spatio-temporal-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/04-Descriptive-Spatio-Temporal-Statistical-Models.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
